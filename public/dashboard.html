<!doctype html>
<html lang="ru">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>JARDAM4Y — Личный кабинет</title>
  <link rel="stylesheet" href="/styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

</head>

<body>
  <header class="site-header">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <img src="/photo/enactus-logo.png" alt="JARDAM4Y logo" class="site-logo">
        <h4>Личный кабинет</h4>
      </div>
      <button onclick="location.href='/'" class="icon-btn" title="На главную" style="margin-left: auto;">
        <i class="fas fa-home"></i>
      </button>
    </div>
  </header>

  <main class="dashboard-container">
    <!-- Сообщение об успехе/ошибке -->
    <div id="message" class="message"></div>

    <!-- Кнопка создания -->
    <div class="form-toggle">
      <button id="toggleFormBtn" class="btn primary">+ Создать новую заявку</button>
    </div>

    <!-- Форма создания/редактирования -->
    <div id="formSection" class="form-section">
      <div class="card">
        <h3 id="formTitle">Создать новую заявку</h3>
        <form id="applicationForm">
          <div class="form-group">
            <label>Имя *</label>
            <input type="text" name="name" required placeholder="Введите ваше имя">
          </div>

          <div class="form-group">
            <label>Контакт (телефон/WhatsApp) *</label>
            <input type="text" name="contact" required placeholder="+966 552345346">
          </div>

          <div class="form-group">
            <label>Категория *</label>
            <select name="category" required>
              <option value="">Выберите категорию</option>
              <option value="Няня (для детей)">Няня (для детей)</option>
              <option value="Няня (пожилые)">Няня (пожилые)</option>
              <option value="Бытовые услуги">Бытовые услуги</option>
              <option value="Уход за животными">Уход за животными</option>
              <option value="Другие услуги">Другие услуги</option>
            </select>
          </div>

          <div class="form-group">
            <label>Описание задания</label>
            <textarea name="description" placeholder="Подробное описание вашего задания..."></textarea>
          </div>

          <div class="form-group">
            <label>Дата/Время выполнения</label>
            <input type="datetime-local" name="datetime">
          </div>

          <div class="form-group">
            <label>Цена</label>
            <input type="text" name="price" placeholder="например: 500 сом.">
          </div>

          <div class="actions">
            <button type="submit" class="btn primary">Создать заявку</button>
            <button type="button" class="btn muted" onclick="resetForm()">Отмена</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Список заявок -->
    <div>
      <h2 style="margin-bottom: 20px; color: var(--primary);">Ваши заявки (<span id="appCount">0</span>)</h2>
      <div id="loadingState" class="loading">Загрузка...</div>
      <div id="emptyState" class="empty-state" style="display: none;">У вас нет заявок. Создайте первую!</div>
      <div id="applicationsList" class="applications-grid"></div>
    </div>
  </main>
  <footer class="site-footer">
    <div class="footer-container">
      <div class="footer-column">
        <h3>JARDAM4Y</h3>
        <p>Это социальная платформа, созданная командой Enactus МУЦА. Наша цель — помочь жителям города Токмок
          справляться с бытовыми и семейными задачами.</p>
      </div>
      <div class="footer-column">
        <h3>Контакты</h3>
        <ul class="footer-links">
          <li><i class="fa-solid fa-location-dot"></i> г. Токмок, ул. Сарыбагышева 1</li>
          <li><i class="fa-solid fa-envelope"></i> enactus@iuca.kg</li>
          <li><i class="fa-solid fa-phone"></i> +996 (XXX) XX-XX-XX</li>
        </ul>
      </div>
      <div class="footer-column">
        <h3>Поддержка</h3>
        <div class="social-links">
          <a href="https://wa.me/996700399535" target="_blank" class="social-btn whatsapp">
            <i class="fa-brands fa-whatsapp"></i> Написать в WhatsApp
          </a>
          <a href="https://www.instagram.com/enactus.iuca.kg?igsh=dG94bGhmMW5mOWYw" target="_blank" class="social-btn instagram">
            <i class="fa-brands fa-instagram"></i> Instagram
          </a>
        </div>
      </div>
    </div>
    <div class="footer-bottom">
      © 2024 JARDAM4Y — MVP. Все права защищены.
    </div>
  </footer>




  <script>
    let applications = [];
    let editingId = null;

    // Инициализация
    document.addEventListener('DOMContentLoaded', () => {
      loadApplications();
      document.getElementById('toggleFormBtn').addEventListener('click', toggleForm);
      document.getElementById('applicationForm').addEventListener('submit', handleSubmit);
    });

    // Загрузка заявок пользователя
    async function loadApplications() {
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          showMessage('❌ Требуется авторизация', 'error');
          setTimeout(() => location.href = '/auth.html', 2000);
          return;
        }

        const res = await fetch('/api/applications/my', {
          headers: { 'x-auth-token': token }
        });

        if (res.status === 401) {
          showMessage('❌ Сессия истекла. Войдите снова', 'error');
          setTimeout(() => location.href = '/auth.html', 2000);
          return;
        }

        applications = await res.json() || [];
        renderApplications();
        document.getElementById('loadingState').style.display = 'none';
      } catch (err) {
        console.error('Ошибка загрузки:', err);
        showMessage('❌ Ошибка при загрузке заявок', 'error');
        document.getElementById('loadingState').style.display = 'none';
      }
    }

    // Рендер списка заявок
    function renderApplications() {
      const count = document.getElementById("appCount");
      const list = document.getElementById("applicationsList");
      const empty = document.getElementById("emptyState");

      count.textContent = applications.length;

      if (applications.length === 0) {
        list.innerHTML = "";
        empty.style.display = "block";
        return;
      }

      empty.style.display = "none";

      list.innerHTML = applications.map(app => `
        <div class="app-card">
          <h4>${app.name}</h4>
          <p>${app.contact}</p>
          <p>${app.category}</p>
          ${app.description ? `<p class="description">${app.description}</p>` : ""}
          ${app.datetime ? `<p>${new Date(app.datetime).toLocaleDateString("ru-RU")}</p>` : ""}
          ${app.price ? `<p class="price">${app.price}</p>` : ""}
          
          <div class="app-buttons">
            <button class="btn primary" onclick="editApplication(${app.id})"> Редактировать</button>
            <button class="btn btn-delete" onclick="deleteApplication(${app.id})"> Удалить</button>
          </div>
        </div>
      `).join("");
    }

    // Переключение формы
    function toggleForm() {
      const form = document.getElementById("formSection");
      const btn = document.getElementById("toggleFormBtn");
      form.classList.toggle("show");
      btn.textContent = form.classList.contains("show") ? "✕ Закрыть форму" : "+ Создать новую заявку";
    }

    // CREATE / UPDATE
    async function handleSubmit(e) {
      e.preventDefault();
      const formData = new FormData(document.getElementById("applicationForm"));
      const data = Object.fromEntries(formData);

      if (editingId) {
        await updateApplication(editingId, data);
      } else {
        await createApplication(data);
      }
    }

    // CREATE
    async function createApplication(data) {
      const token = localStorage.getItem('token');
      try {
        const res = await fetch("/api/applications", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "x-auth-token": token
          },
          body: JSON.stringify({ ...data, created_at: new Date().toISOString() }),
        });
        const result = await res.json();

        if (result.success) {
          resetForm();
          loadApplications();
          showMessage("Заявка создана успешно!", "success");
        } else {
          showMessage("Ошибка при создании заявки", "error");
        }
      } catch (err) {
        showMessage("Ошибка при создании заявки", "error");
      }
    }

    // UPDATE
    async function updateApplication(id, data) {
      const token = localStorage.getItem('token');
      try {
        const res = await fetch(`/api/applications/${id}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "x-auth-token": token
          },
          body: JSON.stringify(data),
        });
        const result = await res.json();

        if (result.success) {
          resetForm();
          loadApplications();
          showMessage("Заявка обновлена успешно!", "success");
        } else {
          showMessage("Ошибка: " + result.error, "error");
        }
      } catch (err) {
        showMessage("Ошибка при обновлении", "error");
      }
    }

    // DELETE
    async function deleteApplication(id) {
      if (!confirm("Удалить заявку?")) return;
      const token = localStorage.getItem('token');

      try {
        const res = await fetch(`/api/applications/${id}`, {
          method: "DELETE",
          headers: {
            "Content-Type": "application/json",
            "x-auth-token": token
          },
        });

        const text = await res.text();
        let result = {};

        try {
          result = JSON.parse(text);
        } catch { }

        if (res.ok && result.success) {
          loadApplications();
          showMessage("Заявка удалена!", "success");
        } else {
          showMessage("Ошибка удаления", "error");
        }
      } catch (err) {
        showMessage("Ошибка сети", "error");
      }
    }

    // EDIT
    function editApplication(id) {
      const app = applications.find((a) => a.id === id);
      if (!app) return;

      editingId = id;
      const form = document.getElementById("applicationForm");
      form.name.value = app.name;
      form.contact.value = app.contact;
      form.category.value = app.category;
      form.description.value = app.description || "";
      form.datetime.value = app.datetime || "";
      form.price.value = app.price || "";

      document.getElementById("formTitle").textContent = "Редактировать заявку";
      document.querySelector('#applicationForm button[type="submit"]').textContent = "Сохранить";

      document.getElementById("formSection").classList.add("show");
      document.getElementById("toggleFormBtn").textContent = "Закрыть форму";
    }

    // RESET
    function resetForm() {
      editingId = null;
      document.getElementById("applicationForm").reset();
      document.getElementById("formTitle").textContent = "Создать новую заявку";
      document.querySelector('#applicationForm button[type="submit"]').textContent = "Создать заявку";
      document.getElementById("formSection").classList.remove("show");
      document.getElementById("toggleFormBtn").textContent = "Создать новую заявку";
    }

    // Сообщения
    function showMessage(text, type) {
      const msg = document.getElementById("message");
      msg.textContent = text;
      msg.className = `message show ${type}`;
      setTimeout(() => msg.classList.remove("show"), 3000);
    }
  </script>
</body>

</html>
